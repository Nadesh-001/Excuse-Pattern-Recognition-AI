{% extends "base.html" %}

{% block title %}AI Assistant - Excuse Pattern AI{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/premium_chatbot.css') }}">
<style>
    /* Local Overrides for layout */
    .chat-layout {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .chat-window {
        height: 75vh;
        display: flex;
        flex-direction: column;
        border-radius: 24px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        scroll-behavior: smooth;
    }

    /* Scrollbar Styling */
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    .message {
        max-width: 85%;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-content {
        padding: 1rem 1.5rem;
        border-radius: 18px;
        font-size: 1rem;
        line-height: 1.6;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .assistant .message-content {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-top-left-radius: 4px;
        color: #f3f4f6;
    }

    .user {
        display: flex;
        justify-content: flex-end;
    }

    .user .message-content {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        border-top-right-radius: 4px;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
    }

    .chat-input-container {
        padding: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(0, 0, 0, 0.2);
    }

    .modern-input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1rem 1.5rem;
        color: white;
        width: 100%;
        resize: none;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }

    .modern-input:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        background: rgba(0, 0, 0, 0.5);
    }

    .chip {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 99px;
        font-size: 0.85rem;
        color: #9ca3af;
        transition: all 0.2s;
        cursor: pointer;
    }

    .chip:hover {
        background: rgba(34, 197, 94, 0.1);
        border-color: #22c55e;
        color: #4ade80;
        transform: translateY(-1px);
    }

    /* Typewriter Cursor */
    .typing-cursor::after {
        content: '|';
        animation: blink 1s step-start infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0;
        }
    }
</style>

<div class="chat-layout">

    <!-- HERO HEADER -->
    <div style="margin-bottom: 2.5rem; text-align: center;">
        <div
            style="display: inline-flex; align-items: center; justify-content: center; width: 60px; height: 60px; background: rgba(34,197,94,0.1); border-radius: 50%; box-shadow: 0 0 30px rgba(34,197,94,0.2); margin-bottom: 1rem;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
                <path d="M8.5 8.5v.01"></path>
                <path d="M16 8.5v.01"></path>
                <path d="M12 16.5v.01"></path>
            </svg>
        </div>
        <h1 class="text-3xl font-bold" style="font-size: 2.5rem; margin-bottom: 0.5rem;">
            <span
                style="color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.6), 0 0 10px rgba(255, 255, 255, 0.4);">AI</span>
            <span class="neon-text-green">Assistant</span>
        </h1>
        <p style="color: #9ca3af; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
            Analyze tasks, detect patterns, and optimize workflow with <span
                style="color: white; font-weight: 500;">Intelligence</span>.
        </p>
    </div>

    <!-- MAIN CHAT WINDOW -->
    <div class="chat-window glass-panel chat-container-premium">

        <!-- MESSAGES AREA -->
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome -->
            <div class="message assistant">
                <div class="message-content">
                    Hello <span style="color: #4ade80; font-weight: 600;">{{ session.user_name.split()[0] }}</span>! I'm
                    ready to assist.<br>
                    Try "Analyze my delays" or "Show pending tasks".
                </div>
            </div>
        </div>

        <!-- TYPING INDICATOR -->
        <div id="typing-indicator"
            style="display: none; padding: 0 2rem 1rem 2rem; color: #4ade80; font-size: 0.9rem; align-items: center; gap: 0.5rem;">
            <div class="typing-dots"><span></span><span></span><span></span></div>
            <span>Processing...</span>
        </div>

        <!-- INPUT AREA -->
        <div class="chat-input-container">

            <!-- CHIPS -->
            <div style="display: flex; gap: 0.75rem; overflow-x: auto; margin-bottom: 1rem; padding-bottom: 0.5rem;">
                <div class="chip" onclick="sendQuickAction('Summarize my tasks')">üìä Summarize Tasks</div>
                <div class="chip" onclick="sendQuickAction('Analyze details')">üîç Analyze Details</div>
                <div class="chip" onclick="sendQuickAction('High risk delays')">‚ö†Ô∏è High Risks</div>
                <div class="chip" onclick="sendQuickAction('Help!')">üí° Help</div>
            </div>

            <!-- INPUT FIELD -->
            <div style="position: relative; display: flex; gap: 1rem; align-items: flex-end;">
                <textarea id="chat-input" class="modern-input" rows="1" placeholder="Type your request here..."
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>

                <button onclick="sendMessage()"
                    style="background: #22c55e; border: none; width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const typingIndicator = document.getElementById('typing-indicator');

    function sendQuickAction(text) {
        chatInput.value = text;
        sendMessage();
    }

    async function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        // User Message
        appendMessage('user', text);
        chatInput.value = '';

        // Show Loading
        typingIndicator.style.display = 'flex';
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            const response = await fetch('/chatbot/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();

            typingIndicator.style.display = 'none';

            if (data.error) {
                appendMessage('assistant', 'Error: ' + data.error);
            } else {
                typewriteMessage(data.response);
            }

        } catch (e) {
            typingIndicator.style.display = 'none';
            appendMessage('assistant', 'Connection error.');
        }
    }

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = `<div class="message-content">${text}</div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function typewriteMessage(text) {
        const div = document.createElement('div');
        div.className = 'message assistant';
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content typing-cursor'; // Add cursor effect

        // Format HTML (bold, breaks) but type plain text logic? 
        // Simple typewriter: just add characters. 
        // For HTML content, it's trickier. Let's process simplified HTML.
        const formatted = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        contentDiv.innerHTML = '';

        div.appendChild(contentDiv);
        chatMessages.appendChild(div);

        // Very basic "stream" simulation for visual effect
        let i = 0;
        // Strip HTML tags for typing char count? No, that breaks tags.
        // Let's just set innerHTML immediately for now to ensure HTML renders correctly, 
        // OR implement a smart typer. For reliability:

        contentDiv.innerHTML = formatted;
        contentDiv.classList.add('fade-in-text'); // CSS animation instead of JS typing for robustness with HTML
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
<style>
    .fade-in-text {
        animation: fadeIn 0.5s ease-out;
    }
</style>
{% endblock %}