{% extends "base.html" %}

{% block title %}Task Details - Excuse Pattern AI{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('tasks') }}" class="btn-secondary"
        style="display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-main); padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        Back to Tasks
    </a>
</div>

<div class="card"
    style="background: var(--bg-card); padding: 2rem; border-radius: 1rem; border: 1px solid var(--border);">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
        <div>
            <h1 style="margin: 0; margin-bottom: 0.5rem;">{{ task.title }}</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span style="
                    padding: 4px 10px; border-radius: 20px; font-weight: 600; font-size: 0.8rem;
                    {% if task.status == 'Completed' %}background: rgba(16, 185, 129, 0.2); color: #10b981;
                    {% elif task.status == 'Delayed' %}background: rgba(239, 68, 68, 0.2); color: #ef4444;
                    {% else %}background: rgba(59, 130, 246, 0.2); color: #60a5fa;{% endif %}
                ">
                    {{ task.status }}
                </span>
                <span style="color: var(--text-muted); font-size: 0.9rem;">Due: {{ task.deadline }}</span>
            </div>
        </div>
        <div>
            <div style="text-align: right; color: var(--text-muted); font-size: 0.9rem;">
                <!-- Priority -->
                <div style="margin-bottom: 0.25rem;">
                    Priority:
                    <span
                        style="font-weight: 600; color: {% if task.priority == 'High' %}#ef4444{% elif task.priority == 'Medium' %}#f59e0b{% else %}#10b981{% endif %};">
                        {{ task.priority }}
                    </span>
                </div>
                <!-- Est Time -->
                {% if task.estimated_minutes %}
                <div>
                    Est: {{ task.estimated_minutes // 60 }}h {{ task.estimated_minutes % 60 }}m
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Task
            Description</h3>
        <!-- Prism.js for Syntax Highlighting -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

        <div
            style="background: #2d2d2d; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); overflow-x: auto;">
            <pre
                style="margin: 0;"><code class="language-python">{{ task.description or '# No description provided.' }}</code></pre>
        </div>

        <!-- Validation Demo Button -->
        <div style="margin-top: 1rem; text-align: right;">
            <button onclick="runValidation()"
                style="background: transparent; border: 1px dashed var(--primary); color: var(--primary); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.5rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                </svg>
                Run Validation Check
            </button>
        </div>

        <!-- Simulated Terminal Output -->
        <div id="validation-output"
            style="display: none; margin-top: 1rem; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; border: 1px solid #333;">
            <div id="validation-lines"></div>
        </div>
    </div>

    <!-- Resources -->
    {% if resources %}
    <div style="margin-bottom: 2rem;">
        <h3
            style="font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                    d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" />
            </svg>
            Attachments
        </h3>
        <div style="display: grid; gap: 0.75rem;">
            {% for res in resources %}
            <div
                style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: var(--text-main);">{{ res.title or 'Resource' }}</strong>
                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 0.5rem;">({{
                        res.resource_type }})</span>
                </div>
                <a href="{{ res.url_or_path }}" target="_blank"
                    style="color: var(--primary); font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                    Open
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    {% if task.status != 'Completed' %}
    <div style="border-top: 1px solid var(--border); padding-top: 2rem; margin-top: 2rem;">
        <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem;">Actions</h3>

        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <!-- Complete Logic -->
            <form method="POST" action="{{ url_for('complete_task', task_id=task.id) }}" style="margin: 0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    style="background: #10b981; color: #000; border: 2px solid #10b981; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Mark as Complete
                </button>
            </form>

            <!-- Delay Logic Button -->
            <button
                onclick="document.getElementById('delay-form-container').style.display = document.getElementById('delay-form-container').style.display === 'none' ? 'block' : 'none'"
                style="background: transparent; border: 2px solid #ef4444; color: #ef4444; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Report Issue / Delay
            </button>

            <!-- Delete Logic -->
            <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" style="margin: 0;"
                onsubmit="return confirm('Are you sure you want to delete this task? This action cannot be undone.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit"
                    style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; opacity: 0.7; transition: all 0.2s;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Delete Task
                </button>
            </form>
        </div>

        <!-- Hidden Delay Form -->
        <div id="delay-form-container"
            style="display: none; margin-top: 1.5rem; background: rgba(239, 68, 68, 0.05); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(239, 68, 68, 0.2); animation: fadeIn 0.3s ease;">
            <h4 style="margin-top: 0; color: #fca5a5; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Submit Delay Excuse
            </h4>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">
                    Our AI will analyze your reason and calculate an impact score.
                </p>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Live Analysis Badge -->
                    <div id="live-analysis-badge"
                        style="display: none; align-items: center; gap: 0.5rem; font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; border: 1px solid #9ca3af; background: rgba(156, 163, 175, 0.1); color: #9ca3af; transition: all 0.3s;">
                        <span style="position: relative; display: flex; height: 8px; width: 8px;">
                            <span
                                style="animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; position: absolute; display: inline-flex; height: 100%; width: 100%; border-radius: 50%; background-color: currentColor; opacity: 0.75;"></span>
                            <span
                                style="position: relative; display: inline-flex; border-radius: 50%; height: 8px; width: 8px; background-color: currentColor;"></span>
                        </span>
                        <span id="detected-category">Analyzing...</span>
                    </div>

                    <div id="impact-preview"
                        style="font-size: 0.85rem; font-weight: 600; color: #fca5a5; display: none;">
                        Estimated Impact: <span id="impact-days">+0 days</span>
                    </div>
                </div>
            </div>

            <form method="POST" action="{{ url_for('submit_delay', task_id=task.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="reason" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Reason for
                        delay</label>
                    <textarea id="reason" name="reason" rows="3" required oninput="updateImpactPreview(this.value)"
                        style="width: 100%; padding: 0.75rem; background-color: var(--bg-dark); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-main); font-family: inherit;"
                        placeholder="Explain why this task is delayed..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="proof" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Upload Proof
                        (Optional)</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="file" id="proof" name="proof" style="color: var(--text-muted);"
                            onchange="showUploadSuccess()">
                        <span id="upload-success"
                            style="display: none; color: #10b981; font-weight: 600; font-size: 0.9rem;">
                            ✅ File ready
                        </span>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn-primary"
                        style="background-color: #ef4444; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; color: white;">
                        Submit Excuse
                    </button>
                    <button type="button"
                        onclick="document.getElementById('delay-form-container').style.display = 'none'"
                        style="background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 2rem;">
        <div
            style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span style="font-weight: 600; font-size: 1.1rem;">Task Completed Successfully!</span>
        </div>
    </div>
    {% endif %}

</div>

<script>
    // Add simple fade-in animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // Auto-open delay form if error occurred (passed via query param)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('delay_error')) {
        document.getElementById('delay-form-container').style.display = 'block';
        // Optional: scroll to it
        document.getElementById('delay-form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Impact Score & Category Preview Logic
    function updateImpactPreview(text) {
        const preview = document.getElementById('impact-preview');
        const days = document.getElementById('impact-days');
        const badge = document.getElementById('live-analysis-badge');
        const categoryText = document.getElementById('detected-category');

        if (text.length > 5) {
            preview.style.display = 'block';

            // 1. Predicted Impact (Simple Heuristic)
            let predicted = 1;
            const lowerText = text.toLowerCase();
            if (lowerText.includes("sick") || lowerText.includes("hospital") || lowerText.includes("material")) predicted = 3;
            else if (lowerText.includes("rain") || lowerText.includes("traffic")) predicted = 1;
            else if (text.length > 50) predicted = 2;

            days.innerText = `+${predicted} days`;

            // 2. Live Analysis / Category Detection
            let category = "Analyzing...";
            let color = "#9ca3af"; // Default gray
            let bg = "rgba(156, 163, 175, 0.1)";

            if (lowerText.match(/rain|storm|weather|flood|snow/)) {
                category = "Weather Issue";
                color = "#34d399"; // Green
                bg = "rgba(52, 211, 153, 0.1)";
            } else if (lowerText.match(/labor|staff|worker|shortage|sick|ill|doctor/)) {
                category = "Labor / Health";
                color = "#f59e0b"; // Orange
                bg = "rgba(245, 158, 11, 0.1)";
            } else if (lowerText.match(/material|supply|delivery|stock|part|cement/)) {
                category = "Supply Chain";
                color = "#ef4444"; // Red
                bg = "rgba(239, 68, 68, 0.1)";
            }

            if (category !== "Analyzing...") {
                badge.style.display = "inline-flex";
                badge.style.borderColor = color;
                badge.style.background = bg;
                badge.style.color = color;
                categoryText.innerText = category;
            } else {
                badge.style.display = "none";
            }

        } else {
            preview.style.display = 'none';
            if (badge) badge.style.display = 'none';
        }
    }

    function showUploadSuccess() {
        const fileInput = document.getElementById('proof');
        const successSpan = document.getElementById('upload-success');

        if (fileInput.files && fileInput.files[0]) {
            const fileName = fileInput.files[0].name;
            successSpan.innerHTML = `✅ Ready: <strong>${fileName}</strong>`;
            successSpan.style.display = 'block';
        }
    }

    function runValidation() {
        const output = document.getElementById('validation-output');
        const lines = document.getElementById('validation-lines');
        output.style.display = 'block';
        lines.innerHTML = ''; // Clear previous

        const steps = [
            { text: "> Initializing environment...", delay: 200 },
            { text: "> Loading data modules...", delay: 600 },
            { text: "✅ Syntax Check: PASSED", delay: 1200, color: "#4ade80" },
            { text: "⚠️ Check Missing Values: WARNING (Row 42: NaN)", delay: 1800, color: "#facc15" },
            { text: "✅ Data Type Verification: PASSED", delay: 2400, color: "#4ade80" },
            { text: "> Validation Complete. Ready for processing.", delay: 3000 }
        ];

        let i = 0;
        function addLine() {
            if (i < steps.length) {
                const step = steps[i];
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.textContent = step.text;
                    if (step.color) div.style.color = step.color;
                    div.style.marginBottom = "4px";
                    lines.appendChild(div);
                    i++;
                    addLine();
                }, step.delay - (i > 0 ? steps[i - 1].delay : 0)); // Calculate relative delay
            }
        }

        // Reset delays for simple implementation
        steps.forEach((step, index) => {
            setTimeout(() => {
                const div = document.createElement('div');
                div.textContent = step.text;
                if (step.color) div.style.color = step.color;
                div.style.marginBottom = "4px";
                lines.appendChild(div);
            }, step.delay);
        });
    }
</script>
{% endblock %}